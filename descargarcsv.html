<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOIL | DICTUC</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .custom-button {
            margin-left: auto;
        }
    </style>
</head>

<body class="bg-dark">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <a class="navbar-brand" href="#">SOIL | DICTUC</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
            aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item ">
                    <a class="nav-link" href="index.html">Dashboard</a>
                </li>
                <li class="nav-item active">
                    <a class="nav-link" href="descargarcsv.html">Descargar Datos</a>
                </li>
            </ul>
        </div>
    </nav>
    <div class="container mt-4">
        <div class="card bg-dark text-white">
            <div class="card-header">
                <h5 class="text-center">Descarga personalizada de datos</h5>
            </div>
            <div class="card-body">
                <div class="row justify-content-around">

                    <!-- Filtro por fechas -->
                    <div class="form-group">
                        <label for="month-select">Mes</label>
                        <select id="month-select" class="form-control">
                            <option value="todos">Todos los meses</option>
                            <option value="03">Marzo</option>
                            <option value="04">Abril</option>
                            <option value="05">Mayo</option>
                            <option value="06">Junio</option>
                            <option value="07">Julio</option>
                            <option value="08" disabled>Agosto</option>
                            <option value="09" disabled>Septiembre</option>
                            <option value="10" disabled>Octubre</option>
                            <option value="11" disabled>Noviembre</option>
                            <option value="12" disabled>Diciembre</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="device-select">Dispositivo</label>
                        <select id="device-select" class="form-control">
                            <option value="todos">todos los dispositivos</option>
                            <option value="SOIL-01">Soil-01</option>
                            <option value="SOIL-02">Soil-02</option>
                            <option value="SOIL-03">Soil-03</option>
                            <option value="SOIL-04">Soil-04</option>
                            <option value="SOIL-05">Soil-05</option>
                            <option value="SOIL-06">Soil-06</option>
                            <option value="SOIL-07">Soil-07</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="format-select">Formato</label>
                        <select id="format-select" class="form-control">
                            <option value="csv">CSV</option>
                            <option value="excel">EXCEL</option>
                        </select>
                    </div>
                </div>

                <!-- Botón para descargar los datos -->
                <div class="col-12">
                    <button class="btn btn-success text-white btn-block" id="download-filter-csv-btn">Descargar datos
                        filtrados</button>
                    <button class="btn btn-secondary text-white btn-block" id="download-csv-btn">Descargar todos los
                        datos</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Función para descargar los datos en formato CSV
        function download() {
            let url = "https://api-sensores.cmasccp.cl/listarDatosEstructurados?tabla=datos&disp.id_proyecto=6&formato=xlsx";

            // Crear el enlace para la descarga
            const link = document.createElement('a');
            link.href = url; // Asignar la URL de la API con los parámetros
            link.download = 'datos_filtrados.xlsx'; // Establecer el nombre del archivo

            // Simular un clic en el enlace para iniciar la descarga
            document.body.appendChild(link); // Agregar el enlace al DOM
            link.click(); // Hacer clic en el enlace
            document.body.removeChild(link); // Eliminar el enlace del DOM
        }

        function downloadfilter() {
            let url = "https://api-sensores.cmasccp.cl/listarDatosEstructurados?tabla=datos&disp.id_proyecto=6";

            // Obtener los valores de los filtros
            let month = document.getElementById('month-select').value;
            let device = document.getElementById('device-select').value;
            let format = document.getElementById('format-select').value;

            // Añadir filtro por dispositivo si no es 'todos'
            if (device !== 'todos') {
                url += `&disp.codigo_interno=${device}`;
            }

            // Añadir filtro por mes si no es 'todos'
            if (month !== 'todos') {
                url += `&fecha_inicio=2025-${month}-01&fecha_fin=2025-${month}-31`;
            }

            // Añadir formato si es necesario
            if (format === 'excel') {
                url += '&formato=xlsx'; // Cambiar a formato Excel si se selecciona
            } else if (format === 'csv') {
                url += '&formato=csv';
            }

            // Crear el enlace para la descarga
            const link = document.createElement('a');
            link.href = url; // Asignar la URL de la API con los parámetros
            link.download = 'datos_filtrados.csv'; // Establecer el nombre del archivo

            // Simular un clic en el enlace para iniciar la descarga
            document.body.appendChild(link); // Agregar el enlace al DOM
            link.click(); // Hacer clic en el enlace
            document.body.removeChild(link); // Eliminar el enlace del DOM
        }

        // Inicializar
        window.onload = function () {
            loadOptions();
            loadMockData();
        };

        // Escuchar el clic en el botón de descarga
        document.getElementById('download-csv-btn').addEventListener('click', download);
        document.getElementById('download-filter-csv-btn').addEventListener('click', downloadfilter);

    </script>

</body>

</html>